{% extends "history_base.html" %}
{% load staticfiles %}

{% block custom-head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/leaflet.css' %}" />
    <style type="text/css">
        #map { height: 600px; width: 100%; border: 1px solid #fff; margin-bottom: 12px; }
        #map .card-content, .chart-container .card-content { padding: 5px 10px; }
        #map .card-content strong { font-weight: bold; }
        #map span.legend-item { width: 30px; height: 15px; float: left; margin-right: 10px; border: 1px solid #777; text-align: center; }

        .leaflet-tooltip { background: transparent; border-color: transparent; box-shadow: none; }
        .leaflet-tooltip-right:before { border-right-color: transparent; }
        .badge h5 { margin: 0; }
        .collection-item.avatar { padding-left: 20px !important; min-height: 70px !important; }

        chartpeat,chartlc,chartplan,chart1 { height: 250px; width: 100%; }
        .bar { fill: #ff7f0e; }
        /*.bar:hover { fill: #ffbb78; }*/
        .bar2 { fill: #2ca02c; }
        /*.bar2:hover { fill: #98df8a; }*/

        .chart-container .card-content { text-align: center; }
        /*#ddd*/
    </style>
{% endblock %}

{% block content-title %}Land use & land cover change{% endblock %}

{% block content-body %}
    <!--div class="row content-heading">
      &nbsp;
    </div-->

    <div class="content-box" style="padding: 20px 15px 0px;">
      <div class="row">
        <div class="input-field col s12 m12 l5">
          <select id="cbCommodity">
            {% for c in landcover_list %}
              {% if c.value == "" %}
              <option value="{{ c.value }}" disabled selected>{{ c.name }}</option>
              {% elif c.value == selected_landcover %}
              <option value="{{ c.value }}" selected>{{ c.name }}</option>
              {% else %} 
              <option value="{{ c.value }}">{{ c.name }}</option>
              {% endif %}
            {% endfor %}
          </select>
          <label>Commodity</label>
        </div>
        <div class="input-field col s12 m12 l5">
          <select id="cbPeriod">
            {% for period_text in period %}
              {% if period_text == '' %}
              <option value='' disabled selected>Select period</option>
              {% elif period_text == selected_period %}
              <option value='{{ period_text }}' selected>{{ period_text }}</option>
              {% else %}
              <option value='{{ period_text }}'>{{ period_text }}</option>
              {% endif %}
            {% endfor %}
          </select>
          <label>Period</label>
        </div>
        <div class="input-field col s12 m12 l2 center-align">
          <a id="btnShow" class="waves-effect waves-light btn">Show</a>
        </div>
      </div>
    </div>

    <div class="content-box">
      <div class="row content-heading" style="margin-bottom: 12px;">
        {{ landcover_title | safe }}
      </div>

      <div class="row">
        <div class="col s12 m12 l8">
          <div id="map"></div>
        </div>
        <div class="col s12 m12 l4">
          <ul class="collection" style="margin: 0;">
            <li class="collection-item">
              <span class="badge orange-text"><h5>{{ stat_data.area1 }}</h5></span>Million hectare in {{ stat_data.period1 }}</li>
            <li class="collection-item"><span class="badge orange-text">
              <h5>{{ stat_data.area2 }}</h5></span>Million hectare in {{ stat_data.period2 }}</li>
            <li class="collection-item"><span class="badge orange-text">
              <h5>{{ stat_data.growth }}%</h5></span>Per year</li>
            <li class="collection-item">
              <span class="badge orange-text"><h5>{{ stat_data.num_district }}</h5></span>District with {{ landcover_title | safe }}</li>
            <li class="collection-item avatar">
              <span class="badge orange-text"><br><h5>{{ stat_data.max_district }}</h5></span>Largest {{ landcover_title | safe }} area</li>
            <li class="collection-item avatar">
              <span class="badge orange-text"><br></span>Fastest rate</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="content-box">
      <div class="row content-heading">
        Composition and Configuration
      </div>

      <div class="row" style="margin-bottom: 0">
        <div class="col s12 m12 l4">
          <chartpeat class="chart-container">
        </div>
        <div class="col s12 m12 l4">
          <chartlc class="chart-container">
        </div>
        <div class="col s12 m12 l4">
          <chartplan class="chart-container">
        </div>
      </div>
    </div>

    <div class="content-box">
      <div class="row content-heading">
        Land cover Changes
      </div>

      <div class="row" style="margin-bottom: 0">
        <div class="col s12 m12 l6">
          <chart1 class="chart-container">
        </div>
        <div class="col s12 m12 l6">
          <chart2 class="chart-container">
        </div>
      </div>
    </div>
{% endblock %}

{% block custom-footer %}

<script src="{% static 'js/leaflet.js' %}"></script>
<script src="{% static 'js/d3.min.js' %}"></script>

<script type="text/javascript">
  $(document).ready(function() {
    $('select').material_select();
  });

  $("#btnShow").on( "click", function() {
    var txtCommodity = $("#cbCommodity").val();
    var txtPeriod = $("#cbPeriod").val();

    if (txtCommodity != "" && txtPeriod != "") {
      var url = "/history/lulc/" + txtCommodity + "/" + txtPeriod ;
      //alert(url);
      location.href = url;
    }
    else 
      alert("Please select a commodity and/or a period");
  });
</script>

<!-- script for Map -->
<script type="text/javascript">
  var geojson_data1 =
  {
    "type": "FeatureCollection",
    "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
    "features": [
    {% for feat in map_data1 %}
      {
        "type": "Feature",
        "geometry": {
          "type": "{{ feat.geometry.type }}",
          "coordinates": {{ feat.geometry.coordinates }}
        },
        "properties": {
          {% for key, val in feat.properties.items %}"{{ key }}": "{{ val }}",{% endfor %}
        },
      },
      {% endfor %}
    ]
  }

  var geojson_data2 =
  {
    "type": "FeatureCollection",
    "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
    "features": [
    {% for feat in map_data2 %}
      {
        "type": "Feature",
        "geometry": {
          "type": "{{ feat.geometry.type }}",
          "coordinates": {{ feat.geometry.coordinates }}
        },
        "properties": {
          {% for key, val in feat.properties.items %}"{{ key }}": "{{ val }}",{% endfor %}
        },
      },
      {% endfor %}
    ]
  }

  var geojson_road_url = "{% static 'data/geojson/jalan.geojson' %}";
  var geojson_city_url = "{% static 'data/geojson/ibukota_kabupaten2.geojson' %}";
  var icon_url = "{% static 'images/circle_green_16.png' %}";

  var commodity_title = "{{ landcover_title | safe }}";
  var period_value = "{{ selected_period }}".split("-");
</script>
<script src="{% static 'js/history/mapHelper.js' %}"></script>
<script src="{% static 'js/history/donut3d.js' %}"></script>
<script src="{% static 'js/history/barChart.js' %}"></script>
<script type="text/javascript">
  var min_width = 300;
  var width = 0, height = 0; half_value = 0;
  
  function GenerateSvg(targetChart) {
    var tmp = d3.select(targetChart).append("svg").attr("width", '100%').attr("height", '100%').attr("id",targetChart);
    var $container = $(targetChart), width = $container.width(), height = $container.height();
    if (width < min_width) width = min_width;
    if (height < min_width) height = min_width;
    tmp.attr('viewBox','0 0 '+ width +' '+ height ).attr('preserveAspectRatio','xMinYMin');

    return tmp;
  }

  var pieData = [
  {% if not peat_data.empty %}
    {% for row in peat_data.itertuples %}
      {'x': "{{ row.Index }}",'y': {{ row.COUNT }}},
    {% endfor %}
  {% endif %}
  ];
  var pieData = pieData.map( function(d,i){ return {label:d.x, value:d.y, color:d3.schemeCategory20[i]}; });

  var pieData2 = [
  {% if not landcover_data.empty %}
    {% for row in landcover_data.itertuples %}
      {'x': "{{ row.Index }}",'y': {{ row.COUNT }}},
    {% endfor %}
  {% endif %}
  ];
  var pieData2 = pieData2.map( function(d,i){ return {label:d.x, value:d.y, color:d3.schemeCategory10[i]}; });

  var barData = [
  {% if not landcover_plan.empty %}
    {% for row in landcover_plan.itertuples %}
      {'x': "{{ row.Index }}",'y': {{ row.COUNT }}},
    {% endfor %}
  {% endif %}
  ];

  var barData2 = [
  {% if not landchanges.empty %}
    {% for row in landchanges.itertuples %}
      {'x': "{{ row.Index }}",'y': {{ row.COUNT }}},
    {% endfor %}
  {% endif %}
  ];
  var barData2 = barData2.map( function(d,i){ return {x:d.x, y:d.y/1000000}; });

  var dataset = [{
    label: "Landcover changes"
    {% if not landchange_plan.empty %}
      {% for row in landchange_plan.itertuples %}
        ,"{{ row.Index }}": {{ row.COUNT }}
      {% endfor %}
    {% endif %}
  }];

  var targetChart = "chartpeat";
  var chartTitle = "Peat Composition";
  var svg = GenerateSvg(targetChart);
  $container = $("#" + targetChart), width = $container.width(), height = $container.height();
  half_value = Math.min(width,height)/2;
  Donut3D.draw(targetChart, pieData, width/2, height/2, half_value-15, half_value-15, 8, 0.4,chartTitle);
  
  targetChart = "chartlc";
  chartTitle = commodity_title + " cover Composition";
  svg = GenerateSvg(targetChart);
  $container = $("#" + targetChart), width = $container.width(), height = $container.height();
  half_value = Math.min(width,height)/2;
  Donut3D.draw(targetChart, pieData2, width/2, height/2, half_value-15, half_value-15, 8, 0.4,chartTitle);

  targetChart = "chartplan";
  chartTitle = commodity_title + " cover in landuse planning zone (mil ha)";
  var barData = barData.map( function(d,i){ return {x:d.x, y:d.y/1000000}; });
  var svg = GenerateSvg(targetChart);
  BarChart.horizontal(targetChart,barData,0.35,25,5,"bar2",chartTitle);

  targetChart = "chart1";
  chartTitle = commodity_title + " cover changes (mil ha)";
  var svg = GenerateSvg(targetChart);
  BarChart.vertical(targetChart,barData2,25,25,10,"bar",chartTitle);

  targetChart = "chart2";
  chartTitle = commodity_title + " cover changes (mil ha)"
  var svg = GenerateSvg(targetChart);
  BarChart.SingleStackedHorizontal(targetChart,dataset,25,25,10,chartTitle);
</script>

<script type="text/javascript">
  // var dataset = [{
  //   label: "Landcover changes"
  //   {% if not landchange_plan.empty %}
  //     {% for row in landchange_plan.itertuples %}
  //       ,"{{ row.Index }}": {{ row.COUNT }}
  //     {% endfor %}
  //   {% endif %}
  // }];

  // var color = d3.scaleOrdinal(d3.schemeCategory10.reverse());
  // color.domain(d3.keys(dataset[0]).filter(function(key) { return key !== "label"; }));
  // var divider = 1000;

  // dataset.forEach(function(d) {
  //   var total = 0, y0 = 0, maxval = -1;
  //   d.percent_value = {};

  //   color.domain().forEach(function(name) { 
  //     if (d[name]>maxval) mxval=d[name]; 
  //     total += d[name];
  //     d.percent_value[name] = Math.round( (d[name]/total)*10000 ) / 100;
  //   }) 
  //   divider = (maxval > 150000) ? 1000000 : 1000;
    
  //   d.values = color.domain().map( function(name) { 
  //     var tmp = d[name];
  //     var tmp2 = d[name]/divider;
  //     return {name: name, y0: y0, y1: y0 += +d.percent_value[name], v: tmp2, v2: tmp}; 
  //   });
  //   d.total = d.values[d.values.length - 1].y1;
  // })

  // targetChart = "chart2";
  // var svg = GenerateSvg(targetChart);

  // id = targetChart;
  // margin_left = 25, margin_top = 25;
  // number_of_ticks = 10;

  // var $container = $("#" + id), width = $container.width(), height = $container.height(); 
  // margin_left = (margin_left < 1) ? width*margin_left : margin_left;
  // margin_top = (margin_top < 1) ? height*margin_top : margin_top;
  // var g = d3.select("#"+id).append("g").attr("transform", "translate(" + margin_left + ",0)");
  // height -= margin_top; width -= margin_left;

  // var y = d3.scaleBand().rangeRound([0, height]).padding(0.1);
  // y.domain(dataset.map(function(d) { return d.label; }));
  // var yAxis = d3.axisLeft(y);
  // var linestop = y.bandwidth();

  // var x = d3.scaleLinear().range([0, width]);
  // x.domain([0, d3.max(dataset, function(d) { return d.total; })+5]);
  // var xAxis = d3.axisBottom(x).ticks(number_of_ticks).tickSize(0).tickFormat(d3.format(".2s"));
  // g.append("g").attr("transform", "translate(0," + height + ")").call(xAxis)

  // var bar = g.selectAll(".label").data(dataset).enter()
  //   .append("g").attr("transform", function(d) { return "translate(0," + y(d.label) + ")"; });

  // var bar_enter = bar.selectAll("rect").data(function(d) { return d.values; }).enter();

  // bar_enter.append("rect")
  //   .attr("x", function(d) { return x(d.y0); })
  //   .attr("y", y.bandwidth()*0.7)
  //   .attr("width", function(d) { return x(d.y1) - x(d.y0); })
  //   .attr("height", y.bandwidth()*0.3)
  //   .style("fill", function(d) { return color(d.name); });

  // var text_width = width / dataset[0].values.length;

  // bar_enter.append("polyline")
  //   .attr("fill","none").attr("stroke","black")
  //   .attr("points", function(d,i) {
  //     var x1 = text_width * i + text_width * 0.25;
  //     var y1 = linestop*0.6;
  //     var x2 = x(d.y0) + (x(d.y1) - x(d.y0)) / 2;
  //     var y2 = y.bandwidth() * 0.7 + 5;
  //     return x1 + "," + y1 + " " + x2 + "," + y2; 
  //   });

  // bar_enter.append("text")
  //   .attr("class","label-text")
  //   .text(function(d) { return d.name + ", " + d3.format(".3n")(d.v); })
  //   .attr("x", function(d,i,a) { return text_width*i; })
  //   .attr("y", function(d,i) { return ((i % 2) ? 0.2 : 0.4)*y.bandwidth(); });

  // svg.selectAll(".label-text").call(wrap, text_width, linestop*0.6);

  // function wrap(text, width, finishline) {
  //   text.each(function() {
  //     var text = d3.select(this),
  //         words = text.text().split(/\s+/).reverse(),
  //         word,
  //         line = [],
  //         lineNumber = 0,
  //         lineHeight = 1.1, // ems
  //         x = text.attr("x")
  //         y = text.attr("y"),
  //         dy = 0; //parseFloat(text.attr("dy")),
  //         tspan = text.text(null).append("tspan").attr("x", x).attr("y", y).attr("dy", dy + "em");
      
  //     while (word = words.pop()) {
  //       line.push(word);
  //       tspan.text(line.join(" "));
  //       if (tspan.node().getComputedTextLength() > width) {
  //           line.pop();
  //           tspan.text(line.join(" "));
  //           line = [word];
  //           tspan = text.append("tspan").attr("x", x).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
  //       }
  //     }

  //     var x1 = Math.round(x) + width * 0.25, y1 = Math.round(y) + ( (lineNumber) * 16.5 ) + 5;
  //     d3.select(this.parentNode).append("polyline").attr("fill","none").attr("stroke","black")
  //        .attr("points", x1 + "," + y1 + " " + x1 + "," + Math.round(finishline));
  //   });
  // }

</script>

{% endblock %}